# Render.com 文件存储策略

## 当前存储机制

### 临时文件系统特点
- **位置**: `/tmp/data` (生产环境) 或 `./data` (开发环境)
- **生命周期**: 服务重启时清空
- **容量**: 几GB可用空间
- **访问权限**: 仅当前服务实例

## 存储策略

### 1. 会话级存储 (当前实现)
```
用户上传 → 临时存储 → 处理 → 下载 → 清理
```

**特点:**
- ✅ 适合一次性处理流程
- ✅ 不需要额外配置
- ❌ 服务重启时文件丢失
- ❌ 无法支持文件历史记录

### 2. 内存流式处理 (推荐短期方案)
```
用户上传 → 内存处理 → 直接返回结果
```

**优势:**
- ✅ 不依赖文件系统
- ✅ 处理速度最快
- ✅ 自动清理，无存储问题
- ❌ 限制文件大小 (16MB以内)

### 3. 外部存储集成 (长期方案)
```
用户上传 → AWS S3/云存储 → 处理 → 存储结果
```

**优势:**
- ✅ 永久存储
- ✅ 支持大文件
- ✅ 支持文件版本管理
- ❌ 需要额外配置和费用

## 当前建议

### 财务报告系统特点分析
- **文件类型**: Excel 文件 (通常 < 10MB)
- **处理模式**: 上传 → 分析 → 下载报告
- **用户需求**: 一次性处理，不需要长期存储

### 最适合的方案: **内存流式处理**

#### 实现思路:
1. 用户上传文件到内存
2. 直接处理不落盘
3. 处理结果直接返回下载
4. 自动清理内存

#### 代码示例:
```python
# 不保存文件到磁盘，直接在内存中处理
@app.route('/api/process_memory', methods=['POST'])
def process_in_memory():
    file = request.files['file']
    # 直接读取到内存
    file_content = file.read()
    # 处理逻辑
    result = process_excel_in_memory(file_content)
    # 直接返回结果
    return send_file(result, as_attachment=True)
```

## 文件大小限制

### Render.com 限制
- **请求大小**: 默认 10MB
- **内存使用**: 512MB (免费层)
- **临时存储**: 几GB

### 应用限制
- **当前设置**: 16MB (`MAX_CONTENT_LENGTH`)
- **建议调整**: 32MB (适合大型Excel文件)

## 备用方案: 外部存储

如果需要持久化存储，推荐:

### AWS S3 集成
```python
import boto3

def upload_to_s3(file, filename):
    s3 = boto3.client('s3')
    s3.upload_fileobj(file, 'your-bucket', filename)
    return f"https://your-bucket.s3.amazonaws.com/{filename}"
```

### 成本估算
- **S3 存储**: $0.023/GB/月
- **数据传输**: $0.09/GB
- **API 调用**: $0.0004/1000 requests

### 月度成本示例 (100个用户)
- 存储: 1GB × $0.023 = $0.023
- 传输: 10GB × $0.09 = $0.90
- **总计**: ~$1/月

## 实施建议

### 阶段1: 优化当前流程 (立即)
1. 添加文件大小检查
2. 优化临时文件清理
3. 改进错误处理

### 阶段2: 内存处理 (1-2周)
1. 重构文件处理逻辑
2. 实现流式处理
3. 测试大文件处理

### 阶段3: 外部存储 (可选)
1. 评估用户需求
2. 选择存储服务
3. 实现集成

## 监控建议

### 关键指标
- 文件处理成功率
- 内存使用情况
- 处理时间
- 错误率

### 告警设置
- 内存使用 > 80%
- 文件处理失败率 > 5%
- 响应时间 > 30秒 